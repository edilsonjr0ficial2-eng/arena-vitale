<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Arena Vitale</title>
    <link rel="icon" href="logo2.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS (Mantidos) --- */
        :root { --bg: #111; --card: #222; --primary: #FFD700; --text: #fff; --danger: #ff4d4d; --success: #4dff88; --pending: #ffaa00; }
        body.light-mode { --bg: #f4f4f4; --card: #fff; --text: #000; --primary: #e6c300; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }
        .header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .logo-img { max-height: 70px; width: auto; display: block; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
        .tool-btn { padding: 8px 12px; border-radius: 5px; border: 1px solid #555; background: var(--card); color: var(--text); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; font-weight: bold; transition: 0.2s; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn-logout { background: var(--danger); border: none; color: white; }
        .stats-bar { display: flex; gap: 20px; background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; font-size: 0.9rem; justify-content: space-around; }
        .stat-item span { color: var(--primary); font-weight: 900; font-size: 1.1rem; }
        .controls { display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; background: var(--card); padding: 10px; border-radius: 10px; }
        .nav-btn { background: none; border: 1px solid #555; color: var(--primary); font-size: 1.2rem; cursor: pointer; padding: 5px 15px; border-radius: 5px; }
        .date-display { font-size: 1.1rem; font-weight: bold; text-transform: uppercase; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 1200px; margin: auto; }
        .column { background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .col-header { background: var(--primary); color: #000; padding: 10px; text-align: center; font-weight: 900; text-transform: uppercase; font-size: 0.9rem; }
        .slot { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #333; font-size: 0.85rem; }
        .time-label { font-weight: bold; color: #777; width: 50px; }
        .slot-content { flex: 1; text-align: left; padding-left: 5px; font-weight: 500; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slot-content.booked { color: var(--primary); font-weight: bold; }
        .slot-content.pending { color: var(--pending); font-style: italic; }
        .actions { display: flex; gap: 5px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1rem; transition: 0.2s; padding: 2px; }
        .btn-add { color: #555; } .btn-add:hover { color: var(--success); }
        .btn-del { color: var(--danger); } .btn-del:hover { transform: scale(1.2); }
        .btn-wa { color: var(--success); } .btn-wa:hover { transform: scale(1.2); }
        .btn-pay { color: #ccc; opacity: 0.3; } .btn-pay.paid { color: var(--success); opacity: 1; }
        .btn-confirm { color: var(--pending); animation: pulse 2s infinite; }
        .btn-confirm:hover { color: var(--success); transform: scale(1.2); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #loginOverlay, .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .modal-bg { background: rgba(0,0,0,0.8); z-index: 2000; display: none; }
        .login-box, .modal-box { background: var(--card); padding: 30px; border-radius: 10px; border: 2px solid var(--primary); width: 90%; max-width: 400px; text-align: center; }
        .modal-wide { max-width: 600px; width: 95%; }
        .interdicao-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; max-height: 300px; overflow-y: auto; text-align: left; }
        .interdicao-item { background: #333; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        /* FINANCEIRO */
        .fin-summary { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .fin-card { background: #333; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #444; }
        .fin-card h4 { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        .fin-card span { font-size: 1.2rem; font-weight: 900; }
        .fc-green { color: var(--success); } .fc-red { color: var(--danger); } .fc-gold { color: var(--primary); }
        .fin-list { max-height: 300px; overflow-y: auto; text-align: left; border-top: 1px solid #444; margin-top: 10px; }
        .fin-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .fin-item-left { display: flex; gap: 10px; align-items: center; flex: 1; }
        .fin-info { display: flex; flex-direction: column; align-items: flex-start; }
        .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .dot-in { background: var(--success); } .dot-out { background: var(--danger); }
        .fin-inputs { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin: 10px 0; font-size: 0.9rem; color: #ccc; }
        button.primary-btn { padding: 10px 20px; font-size: 1rem; background: var(--primary); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;}
        button.close-btn { background: #333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; width: 100%; }
        @media print { body { background: white; color: black; } .header, .controls, .actions, .toolbar, #loginOverlay { display: none !important; } .column { border: 1px solid #000; background: white; } .col-header { background: #eee !important; color: black !important; -webkit-print-color-adjust: exact; } .slot-content { color: black; } #printHeader { display: block !important; } }
        #printHeader { display: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <img src="logo2.png" alt="Arena Vitale" class="logo-img" style="margin: 0 auto 15px auto;">
            <input type="password" id="passInput" placeholder="Senha">
            <button class="primary-btn" onclick="tentarLogin()">ACESSAR</button>
        </div>
    </div>

    <div id="printHeader">AGENDA DO DIA <span id="printDate"></span></div>

    <div class="header">
        <div class="top-row">
            <img src="logo2.png" alt="Arena Vitale" class="logo-img">
            <button class="tool-btn btn-logout" onclick="fazerLogout()">Sair üö™</button>
        </div>
        
        <div class="toolbar">
            <button class="tool-btn" onclick="window.open('index.html', '_blank')">üåê Ver Site</button>
            <button class="tool-btn" onclick="abrirModalFinanceiro()">üí∞ Financeiro</button>
            <button class="tool-btn" onclick="gerarRelatorio('clientes')">üë• Clientes</button>
            <button class="tool-btn" onclick="gerarRelatorio('blacklist')">üìú Lista Negra</button>
            <button class="tool-btn" onclick="abrirModalSorteio()">üéÅ Sorteio</button>
            <button class="tool-btn" onclick="copiarAgenda()">üìã Copiar p/ Grupo</button>
            <button class="tool-btn" onclick="abrirModalInterdicao()">‚õî Interditar Hor√°rios</button>
            <button class="tool-btn" onclick="abrirModalAddBloqueio()">‚ûï Add Bloqueio</button>
            <button class="tool-btn" onclick="alternarModo()">üåó Sol/Sombra</button>
            <button class="tool-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">Ocupa√ß√£o: <span id="statOcupacao">0%</span></div>
        <div class="stat-item">Faturamento do Dia: <span id="statFaturamento">R$ 0,00</span></div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="mudarDia(-1)">‚ùÆ</button>
        <div class="date-display" id="dateDisplay">...</div>
        <button class="nav-btn" onclick="mudarDia(1)">‚ùØ</button>
        <button class="nav-btn" onclick="carregarAgenda()" style="margin-left:10px;">‚Üª</button>
    </div>

    <div class="grid-container">
        <div class="column"><div class="col-header">üéæ Chicashoes</div><div id="listaQ1"></div></div>
        <div class="column"><div class="col-header">ü•ê Panificadora</div><div id="listaQ2"></div></div>
    </div>

    <div id="modalFinanceiro" class="modal-bg">
        <div class="modal-box modal-wide">
            <h3 style="color:var(--primary)">Gest√£o Financeira</h3>
            
            <div class="fin-summary">
                <div class="fin-card"><h4>Receitas</h4><span id="finReceitas" class="fc-green">R$ 0,00</span></div>
                <div class="fin-card"><h4>Despesas</h4><span id="finDespesas" class="fc-red">R$ 0,00</span></div>
                <div class="fin-card"><h4>Lucro</h4><span id="finLucro" class="fc-gold">R$ 0,00</span></div>
            </div>

            <h4 style="text-align:left; color:#ccc; margin:10px 0;">Adicionar Lan√ßamento</h4>
            <div class="fin-inputs">
                <select id="finTipo" style="width:30%"><option value="saida">üî¥ Despesa</option><option value="entrada">üü¢ Entrada Extra</option></select>
                <input type="text" id="finDesc" placeholder="Descri√ß√£o (Ex: Luz, √Ågua)" style="width:40%">
                <input type="number" id="finValor" placeholder="Valor" style="width:30%">
            </div>
            <button class="primary-btn" style="margin-top:0;" onclick="salvarTransacao()">SALVAR</button>

            <div class="fin-list" id="listaTransacoes">
                <p style="color:#777; padding:10px;">Carregando...</p>
            </div>

            <button class="close-btn" onclick="document.getElementById('modalFinanceiro').style.display='none'">Fechar</button>
        </div>
    </div>

    <div id="modalManual" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Novo Agendamento</h3>
            <p id="modalInfo" style="margin:10px 0; color:#aaa; font-size:0.9rem;"></p>
            <input type="text" id="manualNome" placeholder="Nome do Jogador / Bloqueio">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="checkMensalista" style="width:auto;">
                <label>Marcar como Mensalista (M)</label>
            </div>
            <button class="primary-btn" onclick="salvarManual()">SALVAR</button>
            <button class="close-btn" onclick="fecharModal()">Cancelar</button>
        </div>
    </div>

    <div id="modalAddBlacklist" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--danger)">Adicionar √† Lista Negra</h3>
            <input type="text" id="blNome" placeholder="Nome do Bloqueado">
            <input type="tel" id="blTel" placeholder="Telefone (apenas n√∫meros)">
            <button class="primary-btn" style="background:var(--danger); color:white;" onclick="adicionarBloqueio()">CONFIRMAR BLOQUEIO</button>
            <button class="close-btn" onclick="document.getElementById('modalAddBlacklist').style.display='none'">Fechar</button>
        </div>
    </div>

    <div id="modalInterdicao" class="modal-bg">
        <div class="modal-box" style="max-width:500px;">
            <h3 style="color:var(--danger)">Interditar Hor√°rios</h3>
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px;">
                <button onclick="marcarTodos(true)" style="font-size:0.8rem; padding:5px;">Marcar Todos</button>
                <button onclick="marcarTodos(false)" style="font-size:0.8rem; padding:5px;">Desmarcar Todos</button>
            </div>
            <div class="interdicao-grid" id="listaInterdicao"></div>
            <button class="primary-btn" style="background:var(--danger); color:white;" onclick="confirmarInterdicao()">‚õî INTERDITAR</button>
            <button class="close-btn" onclick="document.getElementById('modalInterdicao').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="modalSorteio" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Sorteio de Clientes üé≤</h3>
            <div id="displaySorteio" style="font-size:1.5rem; font-weight:bold; color:var(--primary); margin:20px 0;">‚ùì</div>
            <button id="btnSortear" class="primary-btn" onclick="realizarSorteio()">SORTEAR AGORA</button>
            <button class="close-btn" onclick="document.getElementById('modalSorteio').style.display='none'">Fechar</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4Dj4kUKuY9Ji7FP-q5dMZLYESHW1XDW7jTCvnM9xl6RnYi8Z6aISv31ytR3klMCCa/exec"; 
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTlYbHI9mgBo8JbEzXjCddY-w5LJqZdFQDiKy1XkJS5m4mkRPoj0CCgTN5WldIRH-ciFxev14TRijP/pub?output=csv";
        const SENHA_ADMIN = "admin123"; 

        let dataAtual = new Date();
        const horas = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
        const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
        let dadosAgenda = [];
        let tempAgendamento = {};
        let faturamentoDia = 0; 
        let transacoesExtras = [];

        window.onload = function() {
            if(localStorage.getItem('adminAuth') === SENHA_ADMIN) {
                document.getElementById('loginOverlay').style.display = 'none';
                aplicarTemaSalvo();
                carregarAgenda();
            }
        };

        function tentarLogin() {
            if(document.getElementById('passInput').value === SENHA_ADMIN) {
                localStorage.setItem('adminAuth', SENHA_ADMIN);
                document.getElementById('loginOverlay').style.display = 'none';
                aplicarTemaSalvo();
                carregarAgenda();
            } else alert("Senha incorreta!");
        }

        function fazerLogout() { localStorage.removeItem('adminAuth'); location.reload(); }
        function alternarModo() { document.body.classList.toggle('light-mode'); localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark'); }
        function aplicarTemaSalvo() { if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode'); }
        function mudarDia(delta) { dataAtual.setDate(dataAtual.getDate() + delta); carregarAgenda(); }
        function formatarData(date) {
            let diaIndex = date.getDay() === 0 ? 6 : date.getDay() - 1;
            let dia = String(date.getDate()).padStart(2, '0');
            let mes = String(date.getMonth() + 1).padStart(2, '0');
            return { texto: `${diasSemana[diaIndex]} - ${dia}/${mes}`, index: diaIndex };
        }

        // --- FINANCEIRO INTELIGENTE (CORRIGIDO PARA LER VALORES) ---
        function abrirModalFinanceiro() {
            document.getElementById('modalFinanceiro').style.display = 'flex';
            carregarFinanceiro();
        }

        function carregarFinanceiro() {
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ acao: "listar_financeiro" }) })
            .then(r => r.json())
            .then(data => {
                transacoesExtras = data.lista || [];
                renderizarFinanceiro();
            });
        }

        function salvarTransacao() {
            const desc = document.getElementById('finDesc').value;
            const valor = document.getElementById('finValor').value;
            const tipo = document.getElementById('finTipo').value;
            if(!desc || !valor) return alert("Preencha tudo");

            document.getElementById('finDesc').value = "";
            document.getElementById('finValor').value = "";

            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ acao: "salvar_transacao", descricao: desc, valor: valor, tipo: tipo }) 
            })
            .then(() => carregarFinanceiro());
        }

        function apagarTransacao(index) {
            if(confirm("Apagar transa√ß√£o?")) {
                fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ acao: "apagar_transacao", index: index }) })
                .then(() => carregarFinanceiro());
            }
        }

        function renderizarFinanceiro() {
            let html = "";
            let totalDespesas = 0;
            let totalEntradasExtras = 0;

            transacoesExtras.forEach((t, i) => {
                let data = t[0] ? new Date(t[0]).toLocaleDateString('pt-BR') : "-";
                
                // 1. Identifica o Tipo (Entrada/Sa√≠da)
                let tipoRaw = t[1] ? t[1].toString().toLowerCase() : "";
                let isSaida = tipoRaw.includes('saida') || tipoRaw.includes('despesa');
                let isEntrada = tipoRaw.includes('entrada') || tipoRaw.includes('receita');

                let desc = t[2] || "Sem descri√ß√£o";

                // 2. CORRE√á√ÉO INTELIGENTE DE VALOR
                let valorRaw = t[3];
                let valor = 0;

                // Se j√° for n√∫mero, usa direto
                if (typeof valorRaw === 'number') {
                    valor = valorRaw;
                } 
                // Se for texto (Ex: "R$ 1.500,50" ou "50,00"), limpa a formata√ß√£o
                else if (typeof valorRaw === 'string') {
                    let v = valorRaw.replace("R$", "").trim();
                    // Se tiver v√≠rgula, assume formato Brasil (remove ponto de milhar, troca v√≠rgula por ponto)
                    if (v.includes(',')) {
                        v = v.replace(/\./g, "").replace(",", ".");
                    }
                    valor = parseFloat(v);
                }

                if(isNaN(valor)) valor = 0;

                // Define cores
                let corDot = isSaida ? 'dot-out' : 'dot-in';
                let sinal = isSaida ? '- ' : '+ ';
                let corTexto = isSaida ? 'fc-red' : 'fc-green';

                if(isSaida) totalDespesas += valor;
                if(isEntrada) totalEntradasExtras += valor;

                html += `<div class="fin-item">
                    <div class="fin-item-left">
                        <div class="dot ${corDot}"></div>
                        <div class="fin-info">
                            <b>${desc}</b>
                            <span style="font-size:0.7rem;color:#777;">${data}</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="${corTexto}">${sinal}R$ ${valor.toFixed(2)}</span>
                        <button class="btn-icon btn-del" onclick="apagarTransacao(${i})">üóëÔ∏è</button>
                    </div>
                </div>`;
            });

            document.getElementById('listaTransacoes').innerHTML = html || '<p style="text-align:center;color:#555;">Nenhuma transa√ß√£o.</p>';

            // Totais
            let receitasTotais = faturamentoDia + totalEntradasExtras; 
            let lucroLiquido = receitasTotais - totalDespesas;

            document.getElementById('finReceitas').innerText = "R$ " + receitasTotais.toFixed(2);
            document.getElementById('finDespesas').innerText = "R$ " + totalDespesas.toFixed(2);
            document.getElementById('finLucro').innerText = "R$ " + lucroLiquido.toFixed(2);
        }

        // --- AGENDA E OUTRAS FUN√á√ïES (MANTIDAS) ---
        async function carregarAgenda() {
            const info = formatarData(dataAtual);
            document.getElementById('dateDisplay').innerText = info.texto;
            document.getElementById('printDate').innerText = info.texto;
            try { const r = await fetch(SHEET_URL + '&t=' + new Date().getTime()); const csv = await r.text(); processarCSV(csv, info.index); } catch (e) { console.error(e); }
        }
        function processarCSV(csv, diaIndex) {
            const rows = csv.split('\n').map(r => r.split(',')); dadosAgenda = []; let ocupados = 0;
            rows.forEach((row, idx) => {
                if(idx === 0) return; let h = parseInt(row[0]);
                if(!isNaN(h)) {
                    let colQ1 = 1 + diaIndex; let colQ2 = 9 + diaIndex;
                    let nomeQ1 = row[colQ1] ? row[colQ1].replace(/[\r\n"]/g, '').trim() : "";
                    let nomeQ2 = row[colQ2] ? row[colQ2].replace(/[\r\n"]/g, '').trim() : "";
                    if(nomeQ1) ocupados++; if(nomeQ2) ocupados++;
                    dadosAgenda.push({ hora: h, q1: nomeQ1, q2: nomeQ2 });
                }
            });
            let total = horas.length * 2; let porc = Math.round((ocupados / total) * 100);
            faturamentoDia = ocupados * 45; 
            document.getElementById('statOcupacao').innerText = porc + "%";
            document.getElementById('statFaturamento').innerText = "R$ " + faturamentoDia.toFixed(2).replace('.', ',');
            renderizarGrid();
        }
        
        function renderizarGrid() {
            let hQ1 = ""; let hQ2 = "";
            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h) || { q1: "", q2: "" };
                hQ1 += criarSlotHTML(h, 1, slot.q1); hQ2 += criarSlotHTML(h, 2, slot.q2);
            });
            document.getElementById('listaQ1').innerHTML = hQ1; document.getElementById('listaQ2').innerHTML = hQ2;
        }

        function criarSlotHTML(h, q, n) {
            let ocupado = n.length > 0;
            let isPendente = n.includes("‚è≥");
            let botoes = ocupado ? (isPendente ? 
                `<button class="btn-icon btn-wa" onclick="abrirWhatsApp('${n.replace('‚è≥','').trim()}', ${h})">üìû</button>
                 <button class="btn-icon btn-confirm" onclick="confirmarAgendamento(${h}, ${q}, '${n}')">üÜó</button>
                 <button class="btn-icon btn-del" onclick="cancelar(${h}, ${q}, '${n}')">üóëÔ∏è</button>` : 
                `<button class="btn-icon btn-wa" onclick="abrirWhatsApp('${n}', ${h})">üìû</button>
                 <button class="btn-icon btn-pay ${n.includes('‚úÖ')?'paid':''}" onclick="togglePago(${h}, ${q}, '${n}')">üí≤</button>
                 <button class="btn-icon btn-del" onclick="cancelar(${h}, ${q}, '${n}')">üóëÔ∏è</button>`) 
                : `<button class="btn-icon btn-add" onclick="abrirManual(${h}, ${q})">‚ûï</button>`;
            
            let classe = isPendente ? "pending" : (ocupado ? "booked" : "");
            return `<div class="slot"><span class="time-label">${h}:00</span><div class="slot-content ${classe}">${n || "Livre"}</div><div class="actions">${botoes}</div></div>`;
        }

        function abrirModalAddBloqueio() { document.getElementById('modalAddBlacklist').style.display = 'flex'; }
        function adicionarBloqueio() {
            const n = document.getElementById('blNome').value; const t = document.getElementById('blTel').value;
            if(!n) return alert("Nome?");
            if(confirm(`Bloquear ${n}?`)) { enviarFetch({ acao: "bloquear", nome: n, telefone: t }); document.getElementById('blNome').value=""; document.getElementById('blTel').value=""; document.getElementById('modalAddBlacklist').style.display='none'; }
        }
        function enviarFetch(d) { fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(d) }).then(() => setTimeout(carregarAgenda, 2000)).catch(e => alert("Erro.")); }
        function abrirWhatsApp(n, h) { let num = prompt(`N√∫mero:`, ""); if(num) window.open(`https://wa.me/55${num}?text=${encodeURIComponent(`Ol√° ${n}, confirmando ${h}h`)}`, '_blank'); }
        function togglePago(h, q, n) { let nv = n.includes("‚úÖ") ? n.replace(/ ?‚úÖ/g, "") : n + " ‚úÖ"; enviarComando("agendar", h, q, nv); }
        function confirmarAgendamento(h, q, n) { if(confirm(`Confirmar?`)) enviarComando("agendar", h, q, n.replace("‚è≥", "").trim()); }
        function abrirManual(h, q) { tempAgendamento = { hora: h, quadra: q }; document.getElementById('modalInfo').innerText = `${h}:00 - Q${q}`; document.getElementById('manualNome').value = ""; document.getElementById('modalManual').style.display = 'flex'; document.getElementById('manualNome').focus(); }
        function fecharModal() { document.getElementById('modalManual').style.display = 'none'; }
        function salvarManual() {
            let n = document.getElementById('manualNome').value; if(!n) return alert("Nome?");
            if(document.getElementById('checkMensalista').checked) n += " (M)";
            enviarComando("agendar", tempAgendamento.hora, tempAgendamento.quadra, n); fecharModal();
        }
        function cancelar(h, q, n) { if(confirm(`Apagar ${n}?`)) enviarComando("cancelar", h, q, ""); }
        function enviarComando(a, h, q, n) {
            let i = dadosAgenda.findIndex(d => d.hora === h); if(i === -1) { dadosAgenda.push({hora:h, q1:"", q2:""}); i = dadosAgenda.length-1; }
            if(q === 1) dadosAgenda[i].q1 = (a === "agendar" ? n : ""); else dadosAgenda[i].q2 = (a === "agendar" ? n : "");
            renderizarGrid(); enviarFetch({ acao: a, nome: n, diaIndex: formatarData(dataAtual).index, hora: h, quadra: q, duracao: 1, adminOverride: true });
        }
        function copiarAgenda() {
            let t = `üìÖ *Agenda (${formatarData(dataAtual).texto})*\n\n*Quadra 1:*\n`;
            horas.forEach(h => { let s = dadosAgenda.find(d => d.hora === h); let st = s && s.q1 ? (s.q1.includes("‚è≥") ? "‚è≥ Pendente" : "‚ùå Ocupado") : "‚úÖ Livre"; t += `${h}h - ${st}\n`; });
            t += `\n*Quadra 2:*\n`;
            horas.forEach(h => { let s = dadosAgenda.find(d => d.hora === h); let st = s && s.q2 ? (s.q2.includes("‚è≥") ? "‚è≥ Pendente" : "‚ùå Ocupado") : "‚úÖ Livre"; t += `${h}h - ${st}\n`; });
            navigator.clipboard.writeText(t).then(() => alert("Copiado!"));
        }
        
        function abrirModalInterdicao() { document.getElementById('modalInterdicao').style.display = 'flex'; let html = ""; horas.forEach(h => { html += `<div class="interdicao-item"><input type="checkbox" class="chk-interdicao" data-hora="${h}" data-quadra="1"> <label>${h}:00 - Chicashoes</label></div><div class="interdicao-item"><input type="checkbox" class="chk-interdicao" data-hora="${h}" data-quadra="2"> <label>${h}:00 - Panificadora</label></div>`; }); document.getElementById('listaInterdicao').innerHTML = html; }
        function marcarTodos(status) { document.querySelectorAll('.chk-interdicao').forEach(chk => chk.checked = status); }
        function confirmarInterdicao() { let sel = []; document.querySelectorAll('.chk-interdicao:checked').forEach(chk => { sel.push({ hora: chk.getAttribute('data-hora'), quadra: chk.getAttribute('data-quadra') }); }); if(sel.length === 0) return alert("Selecione um hor√°rio."); if(confirm(`Interditar ${sel.length} hor√°rios?`)) { enviarFetch({ acao: "bloqueio_lote", itens: sel, diaIndex: formatarData(dataAtual).index }); document.getElementById('modalInterdicao').style.display='none'; } }

        function gerarRelatorio(tipo) { let win = window.open("", "_blank"); win.document.write("Carregando..."); fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ acao: tipo === 'clientes' ? "listar_clientes" : "listar_blacklist" }) }).then(r => r.json()).then(data => { 
            let html = `<html><head><title>Relat√≥rio</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #333;padding:8px;}</style></head><body><h1>${tipo}</h1><table><tbody>`;
            data.lista.forEach(r => { html += `<tr><td>${r.join('</td><td>')}</td></tr>`; });
            html += `</tbody></table></body></html>`;
            win.document.body.innerHTML = html;
        }); }

        function abrirModalSorteio() { document.getElementById('modalSorteio').style.display = 'flex'; }
        function realizarSorteio() {
            const btn = document.getElementById('btnSortear'); const display = document.getElementById('displaySorteio');
            btn.disabled = true; btn.innerText = "Sorteando...";
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ acao: "sortear_cliente" }) })
            .then(r => r.json())
            .then(data => {
                if (data.erro) { display.innerText = "Erro"; alert(data.erro); }
                else { let v = data.vencedor; display.innerHTML = `${v.nome}<br><span style="font-size:1rem;color:#ccc;">${v.telefone}</span>`; }
                btn.disabled = false; btn.innerText = "SORTEAR AGORA";
            });
        }
    </script>
</body>
</html>

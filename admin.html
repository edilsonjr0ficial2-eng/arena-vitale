<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Arena Vitale</title>
    
    <link rel="icon" href="logo2.png" type="image/png">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #111; --card: #222; --primary: #FFD700; --text: #fff; 
            --danger: #ff4d4d; --success: #4dff88; --info: #4da6ff;
        }
        
        /* MODO CLARO (SOL) */
        body.light-mode { --bg: #f4f4f4; --card: #fff; --text: #000; --primary: #e6c300; }
        body.light-mode .slot { border-bottom: 1px solid #ddd; }
        body.light-mode .column { border: 1px solid #ccc; }
        body.light-mode .black-item { background: #eee; border-color: #ccc; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }

        /* HEADER & TOOLBAR */
        .header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        
        .logo-img { max-height: 70px; width: auto; display: block; }
        
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
        .tool-btn { padding: 8px 12px; border-radius: 5px; border: 1px solid #555; background: var(--card); color: var(--text); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; font-weight: bold; transition: 0.2s; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn-logout { background: var(--danger); border: none; color: white; }

        /* ESTAT√çSTICAS */
        .stats-bar { display: flex; gap: 20px; background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; font-size: 0.9rem; justify-content: space-around; }
        .stat-item span { color: var(--primary); font-weight: 900; font-size: 1.1rem; }

        /* CONTROLES DATA */
        .controls { display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; background: var(--card); padding: 10px; border-radius: 10px; }
        .nav-btn { background: none; border: 1px solid #555; color: var(--primary); font-size: 1.2rem; cursor: pointer; padding: 5px 15px; border-radius: 5px; }
        .date-display { font-size: 1.1rem; font-weight: bold; text-transform: uppercase; }

        /* GRID */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 1200px; margin: auto; }
        .column { background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .col-header { background: var(--primary); color: #000; padding: 10px; text-align: center; font-weight: 900; text-transform: uppercase; font-size: 0.9rem; }
        
        .slot { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #333; font-size: 0.85rem; }
        .time-label { font-weight: bold; color: #777; width: 50px; }
        .slot-content { flex: 1; text-align: left; padding-left: 5px; font-weight: 500; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slot-content.booked { color: var(--primary); font-weight: bold; }
        
        /* BOT√ïES DE A√á√ÉO */
        .actions { display: flex; gap: 5px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1rem; transition: 0.2s; padding: 2px; }
        .btn-add { color: #555; } .btn-add:hover { color: var(--success); }
        .btn-del { color: var(--danger); } .btn-del:hover { transform: scale(1.2); }
        .btn-wa { color: var(--success); } .btn-wa:hover { transform: scale(1.2); }
        .btn-pay { color: #ccc; opacity: 0.3; } 
        .btn-pay.paid { color: var(--success); opacity: 1; }
        .btn-pay:hover { opacity: 1; }

        /* MODAIS E OVERLAYS */
        #loginOverlay, .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .modal-bg { background: rgba(0,0,0,0.8); z-index: 2000; display: none; }
        
        .login-box, .modal-box { background: var(--card); padding: 30px; border-radius: 10px; border: 2px solid var(--primary); width: 90%; max-width: 400px; text-align: center; }
        
        /* ESTILOS LISTA NEGRA */
        .blacklist-container { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; text-align: left; }
        .black-item { display: flex; justify-content: space-between; align-items: center; background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; font-size: 0.85rem; border: 1px solid #444; }
        .black-info { color: #ccc; }
        .black-info b { color: var(--danger); }

        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin: 10px 0; font-size: 0.9rem; color: #ccc; }
        button.primary-btn { padding: 10px 20px; font-size: 1rem; background: var(--primary); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;}
        button.close-btn { background: #333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; width: 100%; }

        @media print {
            body { background: white; color: black; }
            .header, .controls, .actions, .toolbar, #loginOverlay { display: none !important; }
            .column { border: 1px solid #000; background: white; }
            .col-header { background: #eee !important; color: black !important; -webkit-print-color-adjust: exact; }
            .slot-content { color: black; }
            .slot-content.booked { color: black; font-weight: bold; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; font-size: 20px; font-weight: bold; }
        }
        #printHeader { display: none; }
        @media (max-width: 700px) { .grid-container { grid-template-columns: 1fr; } .toolbar { justify-content: center; } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <img src="logo2.png" alt="Arena Vitale" class="logo-img" style="margin: 0 auto 15px auto;">
            <input type="password" id="passInput" placeholder="Senha">
            <button class="primary-btn" onclick="tentarLogin()">ACESSAR</button>
        </div>
    </div>

    <div id="printHeader">AGENDA DO DIA <span id="printDate"></span></div>

    <div class="header">
        <div class="top-row">
            <img src="logo2.png" alt="Arena Vitale" class="logo-img">
            <button class="tool-btn btn-logout" onclick="fazerLogout()">Sair üö™</button>
        </div>
        
        <div class="toolbar">
            <button class="tool-btn" onclick="window.open('index.html', '_blank')" title="Ir para o Site P√∫blico">üåê Ver Site</button>
            <button class="tool-btn" onclick="copiarAgenda()">üìã Copiar p/ Grupo</button>
            <button class="tool-btn" onclick="bloqueioEmergencia()">‚õî Interditar Dia</button>
            <button class="tool-btn" onclick="abrirBlacklist()">üìú Lista Negra</button>
            <button class="tool-btn" onclick="alternarModo()">üåó Sol/Sombra</button>
            <button class="tool-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">Ocupa√ß√£o: <span id="statOcupacao">0%</span></div>
        <div class="stat-item">Faturamento (Est.): <span id="statFaturamento">R$ 0,00</span></div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="mudarDia(-1)">‚ùÆ</button>
        <div class="date-display" id="dateDisplay">...</div>
        <button class="nav-btn" onclick="mudarDia(1)">‚ùØ</button>
        <button class="nav-btn" onclick="carregarAgenda()" style="margin-left:10px;">‚Üª</button>
    </div>

    <div class="grid-container">
        <div class="column">
            <div class="col-header">üéæ Chicashoes</div>
            <div id="listaQ1"></div>
        </div>
        <div class="column">
            <div class="col-header">ü•ê Panificadora</div>
            <div id="listaQ2"></div>
        </div>
    </div>

    <div id="modalManual" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Novo Agendamento</h3>
            <p id="modalInfo" style="margin:10px 0; color:#aaa; font-size:0.9rem;"></p>
            <input type="text" id="manualNome" placeholder="Nome do Jogador / Bloqueio">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="checkMensalista" style="width:auto;">
                <label>Marcar como Mensalista (M)</label>
            </div>
            <button class="primary-btn" onclick="salvarManual()">SALVAR</button>
            <button class="close-btn" onclick="fecharModal()">Cancelar</button>
        </div>
    </div>

    <div id="modalBlacklist" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--danger)">Gerenciar Lista Negra</h3>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">Adicione Nome e Telefone para bloquear agendamentos.</p>
            
            <input type="text" id="blNome" placeholder="Nome do Bloqueado">
            <input type="tel" id="blTel" placeholder="Telefone (apenas n√∫meros)">
            
            <button class="primary-btn" style="background:var(--danger); color:white;" onclick="adicionarBloqueio()">ADICIONAR √Ä LISTA</button>
            
            <div class="blacklist-container" id="listaNegraContainer">
                <p style="color:#777; font-size:0.8rem; text-align:center;">Carregando lista...</p>
            </div>

            <button class="close-btn" onclick="fecharModalBlacklist()">Fechar</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4Dj4kUKuY9Ji7FP-q5dMZLYESHW1XDW7jTCvnM9xl6RnYi8Z6aISv31ytR3klMCCa/exec"; 
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTlYbHI9mgBo8JbEzXjCddY-w5LJqZdFQDiKy1XkJS5m4mkRPoj0CCgTN5WldIRH-ciFxev14TRijP/pub?output=csv";
        const SENHA_ADMIN = "admin123"; 

        let dataAtual = new Date();
        const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
        const horas = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
        let dadosAgenda = [];
        let listaNegraCache = [];
        let tempAgendamento = {};

        // --- LOGIN & INICIALIZA√á√ÉO ---
        window.onload = function() {
            if(localStorage.getItem('adminAuth') === SENHA_ADMIN) {
                document.getElementById('loginOverlay').style.display = 'none';
                aplicarTemaSalvo();
                carregarAgenda();
            }
        };

        function tentarLogin() {
            if(document.getElementById('passInput').value === SENHA_ADMIN) {
                localStorage.setItem('adminAuth', SENHA_ADMIN);
                document.getElementById('loginOverlay').style.display = 'none';
                aplicarTemaSalvo();
                carregarAgenda();
            } else alert("Senha incorreta!");
        }

        function fazerLogout() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        function alternarModo() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }
        function aplicarTemaSalvo() {
            if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        }

        function mudarDia(delta) {
            dataAtual.setDate(dataAtual.getDate() + delta);
            carregarAgenda();
        }

        function formatarData(date) {
            let diaIndex = date.getDay() === 0 ? 6 : date.getDay() - 1;
            let dia = String(date.getDate()).padStart(2, '0');
            let mes = String(date.getMonth() + 1).padStart(2, '0');
            return { texto: `${diasSemana[diaIndex]} - ${dia}/${mes}`, index: diaIndex };
        }

        async function carregarAgenda() {
            const info = formatarData(dataAtual);
            document.getElementById('dateDisplay').innerText = info.texto;
            document.getElementById('printDate').innerText = info.texto;
            document.getElementById('listaQ1').innerHTML = '<div style="padding:10px;text-align:center;">‚Üª</div>';
            document.getElementById('listaQ2').innerHTML = '<div style="padding:10px;text-align:center;">‚Üª</div>';

            try {
                const response = await fetch(SHEET_URL + '&t=' + new Date().getTime());
                const csv = await response.text();
                processarCSV(csv, info.index);
            } catch (e) {
                console.error(e);
            }
        }

        function processarCSV(csv, diaIndex) {
            const rows = csv.split('\n').map(r => r.split(','));
            dadosAgenda = []; 
            listaNegraCache = []; // Limpa cache da lista negra
            let ocupados = 0;

            rows.forEach((row, idx) => {
                if(idx === 0) return;
                
                // Processa Agenda
                let h = parseInt(row[0]);
                if(!isNaN(h)) {
                    let colQ1 = 1 + diaIndex; 
                    let colQ2 = 9 + diaIndex;
                    let nomeQ1 = row[colQ1] ? row[colQ1].replace(/[\r\n"]/g, '').trim() : "";
                    let nomeQ2 = row[colQ2] ? row[colQ2].replace(/[\r\n"]/g, '').trim() : "";

                    if(nomeQ1) ocupados++;
                    if(nomeQ2) ocupados++;

                    dadosAgenda.push({ hora: h, q1: nomeQ1, q2: nomeQ2 });
                }

                // Processa Lista Negra (Colunas Z=25 e AA=26 no array base 0)
                // O CSV pode ter aspas extras, vamos limpar
                let nomeBL = row[25] ? row[25].replace(/[\r\n"]/g, '').trim() : "";
                let telBL = row[26] ? row[26].replace(/[\r\n"]/g, '').trim() : "";
                
                if (nomeBL || telBL) {
                    listaNegraCache.push({ nome: nomeBL, tel: telBL });
                }
            });
            
            atualizarEstatisticas(ocupados);
            renderizarGrid();
        }

        function atualizarEstatisticas(ocupados) {
            let totalSlots = horas.length * 2; 
            let porcentagem = Math.round((ocupados / totalSlots) * 100);
            let faturamento = ocupados * 45; 
            
            document.getElementById('statOcupacao').innerText = porcentagem + "%";
            document.getElementById('statFaturamento').innerText = "R$ " + faturamento.toFixed(2).replace('.', ',');
        }

        function renderizarGrid() {
            let htmlQ1 = "";
            let htmlQ2 = "";
            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h) || { q1: "", q2: "" };
                htmlQ1 += criarSlotHTML(h, 1, slot.q1);
                htmlQ2 += criarSlotHTML(h, 2, slot.q2);
            });
            document.getElementById('listaQ1').innerHTML = htmlQ1;
            document.getElementById('listaQ2').innerHTML = htmlQ2;
        }

        function criarSlotHTML(hora, quadra, nome) {
            let ocupado = nome.length > 0;
            let conteudo = ocupado ? `<span class="booked">${nome}</span>` : "Livre";
            let botoes = "";

            if (ocupado) {
                let pagoClass = nome.includes("‚úÖ") ? "paid" : "";
                botoes = `
                    <button class="btn-icon btn-wa" onclick="abrirWhatsApp('${nome}', ${hora})" title="WhatsApp">üìû</button>
                    <button class="btn-icon btn-pay ${pagoClass}" onclick="togglePago(${hora}, ${quadra}, '${nome}')" title="Marcar Pago">üí≤</button>
                    <button class="btn-icon btn-del" onclick="cancelar(${hora}, ${quadra}, '${nome}')" title="Cancelar">üóëÔ∏è</button>
                `;
            } else {
                botoes = `<button class="btn-icon btn-add" onclick="abrirManual(${hora}, ${quadra})" title="Adicionar">‚ûï</button>`;
            }

            return `
                <div class="slot">
                    <span class="time-label">${hora}:00</span>
                    <div class="slot-content ${ocupado ? 'booked' : ''}">${conteudo}</div>
                    <div class="actions">${botoes}</div>
                </div>
            `;
        }

        // --- GEST√ÉO LISTA NEGRA ---
        function abrirBlacklist() {
            document.getElementById('modalBlacklist').style.display = 'flex';
            renderizarListaNegraUI();
        }

        function fecharModalBlacklist() {
            document.getElementById('modalBlacklist').style.display = 'none';
        }

        function renderizarListaNegraUI() {
            const container = document.getElementById('listaNegraContainer');
            if (listaNegraCache.length === 0) {
                container.innerHTML = '<p style="color:#777; font-size:0.8rem; text-align:center;">Nenhum usu√°rio bloqueado.</p>';
                return;
            }

            let html = '';
            listaNegraCache.forEach(item => {
                html += `
                    <div class="black-item">
                        <div class="black-info">
                            <b>${item.nome}</b><br>
                            <span style="font-size:0.75rem;">${item.tel}</span>
                        </div>
                        <button class="btn-icon btn-del" onclick="removerBloqueio('${item.nome}')">üóëÔ∏è</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function adicionarBloqueio() {
            const nome = document.getElementById('blNome').value;
            const tel = document.getElementById('blTel').value;
            
            if(!nome) return alert("Digite pelo menos o nome.");

            if(confirm(`Bloquear ${nome}?`)) {
                // Envia comando especial
                const dados = { acao: "bloquear", nome: nome, telefone: tel };
                enviarFetch(dados);
                
                // Feedback visual imediato (Otimista)
                listaNegraCache.push({ nome: nome, tel: tel });
                renderizarListaNegraUI();
                
                // Limpa campos
                document.getElementById('blNome').value = "";
                document.getElementById('blTel').value = "";
            }
        }

        function removerBloqueio(nome) {
            if(confirm(`Desbloquear ${nome}?`)) {
                const dados = { acao: "desbloquear", nome: nome };
                enviarFetch(dados);
                
                // Remove visualmente
                listaNegraCache = listaNegraCache.filter(item => item.nome !== nome);
                renderizarListaNegraUI();
            }
        }

        function enviarFetch(dadosJSON) {
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(dadosJSON)
            }).then(() => {
                // Recarrega tudo em 2s para garantir sincronia com a planilha
                setTimeout(carregarAgenda, 2000); 
            }).catch(e => alert("Erro ao comunicar com servidor."));
        }

        // --- OUTRAS FUN√á√ïES ---
        function copiarAgenda() {
            let texto = `üìÖ *Agenda Hoje (${formatarData(dataAtual).texto})*\n\n`;
            texto += `*Quadra Chicashoes:*\n`;
            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h);
                let status = slot && slot.q1 ? "‚ùå Ocupado" : "‚úÖ *LIVRE*";
                texto += `${h}:00 - ${status}\n`;
            });
            texto += `\n*Quadra Panificadora:*\n`;
            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h);
                let status = slot && slot.q2 ? "‚ùå Ocupado" : "‚úÖ *LIVRE*";
                texto += `${h}:00 - ${status}\n`;
            });
            texto += `\nüëâ *Agende agora:* [SEU LINK AQUI]`;
            navigator.clipboard.writeText(texto).then(() => alert("Agenda copiada! Cole no WhatsApp."));
        }

        function bloqueioEmergencia() {
            if(!confirm("‚ö†Ô∏è Tem certeza? Isso vai bloquear TODOS os hor√°rios livres de hoje como 'INTERDITADO'.")) return;
            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h);
                if (!slot.q1) enviarComando("agendar", h, 1, "‚õî INTERDITADO");
                if (!slot.q2) enviarComando("agendar", h, 2, "‚õî INTERDITADO");
            });
            alert("Bloqueio de emerg√™ncia enviado!");
        }

        function abrirWhatsApp(nome, hora) {
            let num = prompt(`Digite o n√∫mero para ${nome} (apenas n√∫meros):`, "");
            if(num) {
                let msg = `Ol√° ${nome}, confirmando seu hor√°rio de Beach Tennis hoje √†s ${hora}h na Arena Vitale! üéæ`;
                window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        function togglePago(hora, quadra, nomeAtual) {
            let novoNome = "";
            if (nomeAtual.includes("‚úÖ")) {
                novoNome = nomeAtual.replace(" ‚úÖ", "").replace("‚úÖ", ""); 
            } else {
                novoNome = nomeAtual + " ‚úÖ"; 
            }
            enviarComando("agendar", hora, quadra, novoNome);
        }

        function abrirManual(hora, quadra) {
            tempAgendamento = { hora, quadra };
            document.getElementById('modalInfo').innerText = `${hora}:00 - Quadra ${quadra}`;
            document.getElementById('manualNome').value = "";
            document.getElementById('checkMensalista').checked = false;
            document.getElementById('modalManual').style.display = 'flex';
            document.getElementById('manualNome').focus();
        }

        function fecharModal() { document.getElementById('modalManual').style.display = 'none'; }

        function salvarManual() {
            let nome = document.getElementById('manualNome').value;
            if(!nome) return alert("Digite um nome!");
            
            if(document.getElementById('checkMensalista').checked) {
                nome += " (M)";
            }
            
            enviarComando("agendar", tempAgendamento.hora, tempAgendamento.quadra, nome);
            fecharModal();
        }

        function cancelar(hora, quadra, nome) {
            if(confirm(`Apagar agendamento de ${nome}?`)) {
                enviarComando("cancelar", hora, quadra, "");
            }
        }

        function enviarComando(acao, hora, quadra, nome) {
            let index = dadosAgenda.findIndex(d => d.hora === hora);
            if(index === -1) { dadosAgenda.push({hora, q1:"", q2:""}); index = dadosAgenda.length -1; }
            
            if(quadra === 1) dadosAgenda[index].q1 = (acao === "agendar" ? nome : "");
            else dadosAgenda[index].q2 = (acao === "agendar" ? nome : "");
            
            renderizarGrid(); 

            const dados = {
                acao: acao,
                nome: nome,
                diaIndex: formatarData(dataAtual).index,
                hora: hora,
                quadra: quadra,
                duracao: 1
            };
            enviarFetch(dados);
        }
    </script>
</body>
</html>

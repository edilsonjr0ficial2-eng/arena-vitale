<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Arena Vitale</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #111; --card: #222; --primary: #FFD700; --text: #fff; --danger: #ff4d4d; --success: #4dff88; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 20px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--primary); text-transform: uppercase; }
        .btn-print { background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .btn-print:hover { background: #ddd; }
        .btn-logout { background: transparent; border: 1px solid #555; color: #777; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; margin-left: 10px;}

        /* CONTROLES DE DATA */
        .controls { display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 30px; background: var(--card); padding: 15px; border-radius: 10px; }
        .nav-btn { background: none; border: 1px solid #555; color: var(--primary); font-size: 1.2rem; cursor: pointer; padding: 5px 15px; border-radius: 5px; }
        .date-display { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; }

        /* GRADE DE HOR√ÅRIOS */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: auto; }
        .column { background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .col-header { background: var(--primary); color: #000; padding: 15px; text-align: center; font-weight: 900; text-transform: uppercase; }
        
        .slot { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #333; font-size: 0.95rem; }
        .slot:last-child { border-bottom: none; }
        .time-label { font-weight: bold; color: #777; width: 60px; }
        .slot-content { flex: 1; text-align: left; padding-left: 10px; font-weight: 500; color: #ccc; }
        .slot-content.booked { color: var(--primary); font-weight: bold; }
        .slot-content.loading-action { color: #888; font-style: italic; }
        
        .actions { display: flex; gap: 10px; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        .btn-add { color: #555; }
        .btn-add:hover { color: var(--success); }
        .btn-del { color: var(--danger); }
        .btn-del:hover { transform: scale(1.2); }

        /* LOGIN OVERLAY */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loginOverlay input { padding: 15px; font-size: 1.2rem; border-radius: 5px; border: 2px solid var(--primary); background: #222; color: white; margin-bottom: 15px; text-align: center; }
        #loginOverlay button { padding: 12px 30px; font-size: 1rem; background: var(--primary); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* MODAL MANUAL */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--card); padding: 30px; border-radius: 10px; border: 2px solid var(--primary); width: 90%; max-width: 400px; text-align: center; }
        .modal-box input { width: 100%; padding: 12px; margin: 15px 0; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }
        .modal-box button { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; margin: 5px; }
        .btn-save { background: var(--primary); color: black; }
        .btn-close { background: #333; color: white; }

        /* IMPRESS√ÉO (PDF) */
        @media print {
            body { background: white; color: black; padding: 0; }
            .header, .controls, .actions, .btn-print, #loginOverlay { display: none !important; }
            .grid-container { grid-template-columns: 1fr 1fr; gap: 10px; }
            .column { border: 1px solid #000; box-shadow: none; background: white; }
            .col-header { background: #eee !important; color: black !important; border-bottom: 1px solid #000; -webkit-print-color-adjust: exact; }
            .slot { border-bottom: 1px solid #ddd; padding: 8px; }
            .slot-content { color: black; }
            .slot-content.booked { color: black; font-weight: bold; }
            .date-display { display: block; text-align: center; margin-bottom: 20px; font-size: 20px; color: black; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; font-size: 24px; font-weight: bold; }
        }
        #printHeader { display: none; }

        @media (max-width: 700px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 style="color:var(--primary); margin-bottom: 20px;">ACESSO RESTRITO</h2>
        <input type="password" id="passInput" placeholder="Senha do Admin">
        <button onclick="tentarLogin()">ENTRAR</button>
    </div>

    <div id="printHeader">AGENDA DO DIA <span id="printDate"></span></div>

    <div class="header">
        <div class="logo">PAINEL <span>ADMIN</span></div>
        <div style="display:flex; align-items:center;">
            <button class="btn-print" onclick="window.print()">üñ®Ô∏è PDF</button>
            <button class="btn-logout" onclick="fazerLogout()">Sair</button>
        </div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="mudarDia(-1)">‚ùÆ</button>
        <div class="date-display" id="dateDisplay">Carregando...</div>
        <button class="nav-btn" onclick="mudarDia(1)">‚ùØ</button>
        <button class="nav-btn" onclick="carregarAgenda()" style="font-size:1rem; margin-left:10px;">‚Üª</button>
    </div>

    <div class="grid-container">
        <div class="column">
            <div class="col-header">üéæ Quadra Chicashoes</div>
            <div id="listaQ1"></div>
        </div>
        <div class="column">
            <div class="col-header">ü•ê Quadra Panificadora</div>
            <div id="listaQ2"></div>
        </div>
    </div>

    <div id="modalManual" class="modal-bg">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Agendamento Manual</h3>
            <p id="modalInfo" style="margin-top:5px; color:#aaa; font-size:0.9rem;"></p>
            <input type="text" id="manualNome" placeholder="Nome do Jogador / Bloqueio">
            <button class="btn-close" onclick="fecharModal()">Cancelar</button>
            <button class="btn-save" onclick="salvarManual()">SALVAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4Dj4kUKuY9Ji7FP-q5dMZLYESHW1XDW7jTCvnM9xl6RnYi8Z6aISv31ytR3klMCCa/exec"; 
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTlYbHI9mgBo8JbEzXjCddY-w5LJqZdFQDiKy1XkJS5m4mkRPoj0CCgTN5WldIRH-ciFxev14TRijP/pub?output=csv";
        const SENHA_ADMIN = "admin123"; // <--- SUA SENHA AQUI

        let dataAtual = new Date();
        const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
        // Ajuste de hor√°rios conforme solicitado (at√© 22h)
        const horas = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
        let dadosAgenda = [];
        let tempAgendamento = {};

        // --- SISTEMA DE LOGIN PERSISTENTE ---
        
        // Verifica se j√° est√° logado ao abrir
        window.onload = function() {
            const senhaSalva = localStorage.getItem('adminAuth');
            if(senhaSalva === SENHA_ADMIN) {
                document.getElementById('loginOverlay').style.display = 'none';
                carregarAgenda();
            }
        };

        function tentarLogin() {
            const pass = document.getElementById('passInput').value;
            if(pass === SENHA_ADMIN) {
                localStorage.setItem('adminAuth', pass); // Salva no navegador
                document.getElementById('loginOverlay').style.display = 'none';
                carregarAgenda();
            } else {
                alert("Senha incorreta!");
            }
        }

        function fazerLogout() {
            localStorage.removeItem('adminAuth'); // Remove a senha salva
            location.reload();
        }

        // --- NAVEGA√á√ÉO ---

        function mudarDia(delta) {
            dataAtual.setDate(dataAtual.getDate() + delta);
            carregarAgenda();
        }

        function formatarData(date) {
            let diaIndex = date.getDay() === 0 ? 6 : date.getDay() - 1;
            let dia = String(date.getDate()).padStart(2, '0');
            let mes = String(date.getMonth() + 1).padStart(2, '0');
            return { texto: `${diasSemana[diaIndex]} - ${dia}/${mes}`, index: diaIndex };
        }

        async function carregarAgenda() {
            const info = formatarData(dataAtual);
            document.getElementById('dateDisplay').innerText = info.texto;
            document.getElementById('printDate').innerText = info.texto;
            
            document.getElementById('listaQ1').innerHTML = '<div style="padding:20px; text-align:center;">Carregando...</div>';
            document.getElementById('listaQ2').innerHTML = '<div style="padding:20px; text-align:center;">Carregando...</div>';

            try {
                // Adiciona timestamp para evitar cache
                const response = await fetch(SHEET_URL + '&t=' + new Date().getTime());
                const csv = await response.text();
                processarCSV(csv, info.index);
            } catch (e) {
                // Em caso de erro local (ex: rodando do PC sem servidor), tenta simular vazio
                console.error(e);
                alert("Erro ao carregar. Se estiver rodando localmente, suba para o GitHub.");
            }
        }

        function processarCSV(csv, diaIndex) {
            const rows = csv.split('\n').map(r => r.split(','));
            dadosAgenda = []; 

            rows.forEach((row, idx) => {
                if(idx === 0) return;
                let h = parseInt(row[0]);
                if(!isNaN(h)) {
                    // L√≥gica corrigida para Q1 (col B = index 1) e Q2 (col J = index 9)
                    let colQ1 = 1 + diaIndex;
                    let colQ2 = 9 + diaIndex;

                    let nomeQ1 = row[colQ1] ? row[colQ1].replace(/[\r\n"]/g, '').trim() : "";
                    let nomeQ2 = row[colQ2] ? row[colQ2].replace(/[\r\n"]/g, '').trim() : "";

                    dadosAgenda.push({ hora: h, q1: nomeQ1, q2: nomeQ2 });
                }
            });
            renderizarGrid();
        }

        function renderizarGrid() {
            let htmlQ1 = "";
            let htmlQ2 = "";

            horas.forEach(h => {
                let slot = dadosAgenda.find(d => d.hora === h) || { q1: "", q2: "" };
                htmlQ1 += criarSlotHTML(h, 1, slot.q1);
                htmlQ2 += criarSlotHTML(h, 2, slot.q2);
            });

            document.getElementById('listaQ1').innerHTML = htmlQ1;
            document.getElementById('listaQ2').innerHTML = htmlQ2;
        }

        function criarSlotHTML(hora, quadra, nome) {
            let ocupado = nome.length > 0;
            let conteudo = ocupado ? `<span class="booked">${nome}</span>` : "Livre";
            let botao = ocupado 
                ? `<button class="btn-icon btn-del" onclick="confirmarCancelamento(${hora}, ${quadra}, '${nome}')">üóëÔ∏è</button>`
                : `<button class="btn-icon btn-add" onclick="abrirManual(${hora}, ${quadra})">‚ûï</button>`;

            return `
                <div class="slot">
                    <span class="time-label">${hora}:00</span>
                    <div class="slot-content ${ocupado ? 'booked' : ''}">${conteudo}</div>
                    <div class="actions">${botao}</div>
                </div>
            `;
        }

        // --- A√á√ïES ---

        function abrirManual(hora, quadra) {
            tempAgendamento = { hora, quadra };
            document.getElementById('modalInfo').innerText = `${hora}:00 - Quadra ${quadra}`;
            document.getElementById('manualNome').value = "";
            document.getElementById('modalManual').style.display = 'flex';
            document.getElementById('manualNome').focus();
        }

        function fecharModal() {
            document.getElementById('modalManual').style.display = 'none';
        }

        function salvarManual() {
            let nome = document.getElementById('manualNome').value;
            if(!nome) return alert("Digite um nome!");
            
            enviarComando("agendar", tempAgendamento.hora, tempAgendamento.quadra, nome);
            fecharModal();
        }

        function confirmarCancelamento(hora, quadra, nome) {
            if(confirm(`Tem certeza que deseja APAGAR o hor√°rio de ${nome} √†s ${hora}h?`)) {
                enviarComando("cancelar", hora, quadra, "");
            }
        }

        function enviarComando(acao, hora, quadra, nome) {
            // ATUALIZA√á√ÉO VISUAL INSTANT√ÇNEA (OTIMISTA)
            let index = dadosAgenda.findIndex(d => d.hora === hora);
            
            // Se n√£o existir o hor√°rio no array local, cria um tempor√°rio
            if(index === -1) {
                dadosAgenda.push({ hora: hora, q1: "", q2: "" });
                index = dadosAgenda.findIndex(d => d.hora === hora);
            }

            // Atualiza o dado localmente imediatamente
            if(quadra === 1) dadosAgenda[index].q1 = (acao === "agendar" ? nome : "");
            else dadosAgenda[index].q2 = (acao === "agendar" ? nome : "");
            
            renderizarGrid(); // Redesenha a tela instantaneamente

            // Envia para o servidor em segundo plano
            const dados = {
                acao: acao,
                nome: nome,
                diaIndex: formatarData(dataAtual).index,
                hora: hora,
                quadra: quadra,
                duracao: 1
            };

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(dados)
            }).then(() => {
                // Sucesso! N√£o fazemos nada porque a tela j√° est√° atualizada.
                // IMPORTANTE: N√ÉO CHAMAR 'carregarAgenda()' AQUI PARA EVITAR O CACHE VELHO
                console.log("Comando enviado com sucesso.");
            }).catch(e => {
                alert("Erro de conex√£o. Verifique se a a√ß√£o foi salva.");
                carregarAgenda(); // S√≥ recarrega se der erro de rede
            });
        }
    </script>
</body>
</html>
